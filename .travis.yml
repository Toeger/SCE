language: cpp
dist: bionic

cache:
    ccache: false

services:
    - xvfb

before_install:
    # last line
    - set -o pipefail
    # quietly
    - wget https://github.com/Toeger/quietly/raw/master/quietly
    - chmod +x quietly
    - sudo mv quietly /usr/bin
    # set sources
    - sudo sh -c "printf 'Acquire::Queue-Mode "host";\\nAcquire::Retries 10;\\n' >> /etc/apt/apt.conf"
    # gcc
    - PACKAGES=${PACKAGES}"gcc-8 g++-8 "
    # gdb
    - PACKAGES=${PACKAGES}"gdb "
    # ninja
    - PACKAGES=${PACKAGES}"ninja-build "
    # boost
    - PACKAGES=${PACKAGES}"libboost-all-dev "
    # LSP server clangd
    - PACKAGES=${PACKAGES}"clang-tools-8 "
    # python
    - PACKAGES=${PACKAGES}"python3 "
    # Qt
    - PACKAGES=${PACKAGES}"qtbase5-dev mesa-common-dev "
    # cmake
    - PACKAGES=${PACKAGES}"cmake "
    # grpc
    - sudo add-apt-repository -y ppa:hnakamur/grpc
    - sudo add-apt-repository -y ppa:hnakamur/protobuf
    - PACKAGES=${PACKAGES}"libgrpc-dev libgrpc++-dev libprotobuf-dev protobuf-compiler protobuf-compiler-grpc "
    # Update sources
    - sudo apt-get update

install:
    # install packages
    - echo "Installing "${PACKAGES}
    - sudo quietly apt-get install ${PACKAGES}
    # gcc
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 90
    - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 90
    # clang
    - sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-8 90
    - sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-8 90
    # clangd
    - sudo update-alternatives --install /usr/bin/clangd clangd /usr/bin/clangd-8 90
    # ccache
    - which clang++
    - sudo ln -s $(which ccache) /usr/lib/ccache/clang++
    - sudo ln -s $(which ccache) /usr/lib/ccache/clang
    - which clang++
    - which g++

before_script:
    # Qt
    - export QT_FATAL_WARNINGS=1
    # Sanitizer settings
    - export ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer-8
    - file ${ASAN_SYMBOLIZER_PATH}
    - export UBSAN_OPTIONS=print_stacktrace=1
    - export LSAN_OPTIONS=suppressions=../lsan.supp #ignore Qt's memory leaks
    # print versions
    - g++ --version
    - gcc --version
    - clang++ --version
    - clang --version
    - protoc --version
    - cmake --version
    - ninja --version
    - python --version
    - gdb --version
    - ld --version
    - clangd --version
    - echo $PATH
    # set up python environment
    - mkdir build && cd build
    - quietly cmake -G Ninja ..
    - quietly ninja python_environment
    - cd .. && rm -R build

script:
    - xvfb-run -a sh -e run_all_test_configurations.sh

after_script:
    # ccache stats
    #- ccache -s
